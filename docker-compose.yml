x-kerberos-app: &kerberos-app
  build:
    context: .
    dockerfile: Dockerfile
  image: kerberos-project-app
  environment:
    - PYTHONPATH=/app
  volumes:
    - ./config:/app/config

services:
  # Certificate Authority - The trusted ID issuer
  ca-server:
    <<: *kerberos-app
    container_name: ca_server
    working_dir: /app
    command: python -m ca_server.main
    ports:
      - "5000:5000"
    volumes:
      - ./ca_server:/app/ca_server
      - ca-data:/app/data # Persistent volume for DB and certs
    environment:
      - PYTHONPATH=/app
      - PROVISIONING_SERVER_URL=http://provisioning-server:5001
      - PYTHONUNBUFFERED=1
      - INTERNAL_API_KEY=${INTERNAL_API_KEY}
    networks:
      - kerberos-net
    healthcheck:
      test: [ "CMD-SHELL", "python -c \"import socket; s=socket.socket(); s.settimeout(2); s.connect(('127.0.0.1', 5000))\" || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

  # Primary KDC - The main authentication hub
  primary-kdc:
    <<: *kerberos-app
    container_name: primary_kdc
    working_dir: /app
    command: python -m kdc_server.main --role primary
    ports:
      - "8888:8888" # Using a non-standard port for our custom KDC
    volumes:
      - ./kdc_server:/app/kdc_server
      - kdc-data-primary:/app/db/primary # Persistent volume for the master DB
      - ca-data:/app/data:ro # Read only access to CA's public cert
    environment:
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
    networks:
      - kerberos-net
    healthcheck:
      test: [ "CMD-SHELL", "python -c \"import socket; s=socket.socket(); s.settimeout(2); s.connect(('127.0.0.1', 8888))\" || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    depends_on:
      - ca-server # Needs CA cert to be generated

  provisioning-server:
    <<: *kerberos-app # Assuming it's also a Python app
    container_name: provisioning_server
    working_dir: /app
    command: python -m provisioning_server.main
    ports:
      - "5001:5001"
    volumes:
      - ./provisioning_server:/app/provisioning_server
      - ./kdc_server:/app/kdc_server
      - kdc-data-primary:/app/db/primary
      - kdc-data-replica:/app/db/replica
    environment:
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
      - INTERNAL_API_KEY=${INTERNAL_API_KEY}
    networks:
      - kerberos-net
    healthcheck:
      test: [ "CMD-SHELL", "python -c \"import socket; s=socket.socket(); s.settimeout(2); s.connect(('127.0.0.1', 5001))\" || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    depends_on:
      primary-kdc:
        # Must wait for the primary KDC to init its DB
        condition: service_healthy

  # Replica KDC - The backup for high availability
  replica-kdc:
    <<: *kerberos-app
    container_name: replica_kdc
    working_dir: /app
    command: python -m kdc_server.main --role replica
    ports:
      - "8889:8888"
    volumes:
      - ./kdc_server:/app/kdc_server
      - kdc-data-replica:/app/db/replica # Separate volume for the replica DB
      - ca-data:/app/data:ro
    environment:
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
    networks:
      - kerberos-net
    healthcheck:
      test: [ "CMD-SHELL", "python -c \"import socket; s=socket.socket(); s.settimeout(2); s.connect(('127.0.0.1', 8888))\" || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s # Give it time to wait for primary
    depends_on:
      primary-kdc:
        condition: service_healthy

  # Service Server - The protected application
  service-server:
    <<: *kerberos-app
    container_name: service_server
    working_dir: /app
    command: python -m service_server.main
    ports:
      - "6000:6000"
    volumes:
      - ./service_server:/app/service_server
    environment:
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
    networks:
      - kerberos-net
    healthcheck:
      test: [ "CMD-SHELL", "python -c \"import socket; s=socket.socket(); s.settimeout(2); s.connect(('127.0.0.1', 6000))\" || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    depends_on:
      primary-kdc:
        condition: service_healthy
      replica-kdc:
        condition: service_healthy

# Define named volumes for persistent data
volumes:
  ca-data:
  kdc-data-primary:
  kdc-data-replica:


networks:
  kerberos-net:
    driver: bridge
